---
title: "Analyzing pig movement across populations"
author: Mark Wilber and Sarah Chinn
output:
  html_notebook: default
  pdf_document: default
bibliography: /Users/mqwilber/Dropbox/Documents/Bibfiles/Projects_and_Permits-feral_swine.bib
---

## The question of the analysis

**How is the crop use of feral swine affected by the availability of other food resources on the landscape?**

The goal of this analysis is **not** to build the best possible model of pig movement on a landscape.  Rather, it is to understand how forage resources interact to influence a pig's use of crops.  To this end, we are going to consider more specific questions

1. Given that a pig is in a crop field, how does the gradient of other food resources on the landscape (other crops, NDVI, and masting trees) affect the time that the pig stays in the crop field?
2. Given a pig is not in a crop field, how do the food resources where the pig currently is and the gradient of other food resources affect the tendency of a pig to move toward or away from a given crop?

To answer these two questions, we are going to use the framework of continuous time-discrete-space movement movels described in the previous summary I sent around.  This allows us to leverage the entire GPS movement trajectory of individual pigs in order to answer these questions.

## Data summary

Looking at the median location of a pig over the course of a study as well as the distribution of male and female pigs in the study

```{r}
library(data.table)
library(glmnet)
library(foreach)

tejondat = fread("/Users/mqwilber/Repos/rsf_swine/results/glmdata_by_study/tejon2.csv")
txdat = fread("/Users/mqwilber/Repos/rsf_swine/results/glmdata_by_study/txcamp2.csv")

# Add in sex data
pigattrib = fread("~/Repos/rsf_swine/data/formatted/pig_attributes.csv")[, list(pigID, sex)]

# Check NA values, should have some in the crop values
tejondat[, lapply(.SD, function(x) any(is.na(x)))][1,] == FALSE
txdat[, lapply(.SD, function(x) any(is.na(x)))][1, ] == FALSE

# Merge the pig attributes to the data
tejondat = merge(tejondat, pigattrib, by="pigID")[!is.na(ndvi_loc)]
txdat = merge(txdat, pigattrib, by="pigID")[!is.na(ndvi_loc)]
```

```{r}
library(ggplot2)
meantejon = tejondat[, list(meanlat=median(y.adj), meanlon=median(x.adj), sex=unique(sex)[1]), by=pigID]
ggplot(meantejon) + geom_point(aes(x=meanlon, y=meanlat, color=pigID)) + theme_bw() + xlab("Longitude") + ylab("Latitude")
ggplot(meantejon) + geom_bar(aes(x=sex)) + theme_bw()
```

13 Tejon pigs.  


```{r}
library(ggplot2)
meantx = txdat[, list(meanlat=median(y.adj), meanlon=median(x.adj), sex=unique(sex)[1]), by=pigID]
ggplot(meantx) + geom_point(aes(x=meanlon, y=meanlat, color=pigID)) + theme_bw() + xlab("Longitude") + ylab("Latitude")
ggplot(meantx) + geom_bar(aes(x=sex)) + theme_bw()
```


# Analyzing the influence of different foraging resources on the movement patterns of pigs

A four step analysis

1. Analyze a simple main effect model with no interactions
2. Analyze a time varying GAM model with no interactions
3. Analyze a main effect model with resource interactions and temp/precip interactions
4. Potentially analyze a time-varying GAM model with resource interactions...

**Key assumptions**

1. After accounting for sex, pigs in a population are similar enough that multiple replicates per pig can be considered similar to multiple replicates across pigs at a given time.  

### Step 1: Simple main effects model for Tejon and Camp Bullis

Build a design matrix with the appropriate resources.  

```{r}

# Build the standardized design matrix. See pigfxns.R
source("pigfxns.R")
res = build_design_matrix(tejondat, c("crop"), modeltype="main_effects")
tejondat = res$data
evalform = res$evalform
```

From the formula, extract the design matrix

```{r}
Xmat = model.matrix(evalform, data=tejondat)
# fwrite(as.data.table(Xmat), "../results/temp_tejon.csv")
```


```{r}
require(doMC)
registerDoMC(cores=4)
# Fit overall model with GLM LASSO
fittejon_full = cv.glmnet(Xmat, y=tejondat$z, offset=log(tejondat$tau), family="poisson", 
                       alpha=1, nlambda=20, nfolds=4, parallel=TRUE)
```

```{r}
plot(fittejon_full)
fittejon_full$lambda
fittejon_full$glmnet.fit$beta[, which(fittejon_full$lambda == fittejon_full$lambda.1se), drop=F]
tejonbetas = fittejon_full$glmnet.fit$beta[, which(fittejon_full$lambda == fittejon_full$lambda.min)]
```

At the population-level and with the LASSO, we see

1. Pigs slow down in cells with higher canopy cover
2. Pigs slow down in cells with higher NDVI
3. Pigs slow down in cells with higher masting trees
4. Pigs tend to move faster as the get nearer to crops
4. Pigs move faster near water sources
5. Males move faster/more than females

The only direction bias effect that remains is CRW.  Though there is a weak effect to move toward crops.

---

Population-level LASSO for txcamp pigs.  First get the design matrix

```{r}
txres = build_design_matrix(txdat, c("crop"), modeltype="main_effects")
txdat = txres$data
evalform_tx = txres$evalform
```

Compute the design matrix

```{r}
Xmat_tx = model.matrix(evalform_tx, data=txdat)
```

Fit the GLM LASSO

```{r}
require(doMC)
registerDoMC(cores=4)
# Fit overall model with GLM LASSO
fittxcamp_full = cv.glmnet(Xmat_tx, y=txdat$z, offset=log(txdat$tau), family="poisson", 
                       alpha=1, nlambda=20, nfolds=4, parallel=TRUE)
```

```{r}
plot(fittxcamp_full)
fittxcamp_full$lambda
fittxcamp_full$glmnet.fit$beta[, which(fittxcamp_full$lambda == fittxcamp_full$lambda.1se), drop=F]
```

Results are different than Tejon

1. Strong direction persistence in movement
2. Males move faster than females
3. Pigs tend to move slower in canopy cover
4. Pigs tend to move toward canopy cover
5. Pigs move slower closer to water.
6. Pigs move quicker in higher NDVI
7. Week effects of masting layer
8. Pigs move faster near crops

---

## Step 2: Time-varying analysis for Tejon and Camp Bullis


**Question:** Do we detect a a seasonal effect resource use on pig-movement? 

- Not including interactions between resources
- Not including monthly precipitation and tempurature variables as the montly time variation in resource use should account for this
- Explore daily and montly changes in resource use.
  *Daily effects*: General movement and canopy cover
  *Monthly efects*: Forage resources and water

```{r}
# Extract hour of day for spline fitting
tejondat[,datetime:=as.POSIXct(t, origin = '1970-01-01', tz = 'GMT')]
tejondat[ , hourofday:=hour(datetime)]
tejondat[, monthofyear:=month(datetime)]
```

Build the GAM design matrix for time-varying coefficients

```{r}

source("pigfxns.R")
Xgam_tej  = build_gam_design_matrix(Xmat, tejondat, c("(Intercept)", "crw_z", "sexM"), df=6)

require(doMC)
registerDoMC(cores=4)

# Regularize the fit
fittejon_gam = cv.glmnet(x=Xgam_tej, y=tejondat$z, offset=log(tejondat$tau), 
                    family="poisson", alpha=1, nlambda=20, nfolds=4, parallel=TRUE)

```

Explore the nature of the time-varying effects after LASSO regularization

```{r}
plot(fittejon_gam)
tej_gambetas = fittejon_gam$glmnet.fit$beta[, which(fittejon_gam$lambda == fittejon_gam$lambda.1se), drop=T]
tej_gambetas
```

After strong regularization, how do these effects vary with time?

```{r}
library(ggplot2)
splinehour = s(hourofday, bs="cc", k=6)
pred_hours = Predict.matrix(smooth.construct2(splinehour, tejondat, NULL), data.frame(hourofday=1:24)) # B-spline basis for hour effect

dailyres = list()
for(pattern in c("hour_*")){
  
  coverloc_eff = pred_hours %*% t(t(tej_gambetas[names(tej_gambetas) %like% pattern]))
  coverlocdt = data.frame(hour=1:24, beta=coverloc_eff, coef=pattern)
  dailyres[[pattern]] = coverlocdt
}

dailyres = do.call(rbind, dailyres)
ggplot(dailyres) + geom_line(aes(x=hour, y=beta)) + xlab("Hour of day") + ylab("Daily Rate") + theme_bw() + facet_wrap(~coef)
```

```{r}
library(ggplot2)
splinemonth = s(monthofyear, bs="cc", k=6)
pred_months = Predict.matrix(smooth.construct2(splinemonth, tejondat, NULL), data.frame(monthofyear=seq(1, 12, len=50))) # B-spline basis for month effect

monthlyres = list()
for(pattern in c("cover_loc_*", "cover_grad_*", "crop_grad_*", "crop_loc_*", "water_loc_*", "water_grad_*",
                 "month_*", "masting_loc_*", "masting_grad_*", "ndvi_loc_*", "ndvi_grad_*")){
  
  eff = pred_months %*% t(t(tej_gambetas[names(tej_gambetas) %like% pattern]))
  coverlocdt = data.frame(month=seq(1, 12, len=50), beta=eff, coef=pattern)
  monthlyres[[pattern]] = coverlocdt
}

monthlyres = do.call(rbind, monthlyres)
ggplot(monthlyres) + geom_line(aes(x=month, y=beta)) + xlab("Month of year") + ylab("Monthly Rate") + theme_bw() + facet_wrap(~coef, scales="free")
```


Some interesting results in terms of the time varying effects of resource. 

1. In July, there is an increased tendency to move toward crops, where the rest of the year there is little effect of of crop on the direction of movement
  - Note not sure how much of this is a genearl population-level response versus a strong response of a well-sampled individual.
2. Moreover, pigs tend to move faster nearer crops in the summer and fall months than in the spring
3. In general, pigs move faster nearer water.
4. More movement in general in the fall and winter than in the summer.
5. Less time spent in the higher masting cells in the summer months compared to the winter months
6. The major effect of NDVI on movement is in July through august. This correlated with when pigs are spending more time in higher covered cells and their movement is baised towards these cells.

---

Same analysis now for Camp Bullis pigs.  The only difference is that because pigs are not sampled over an entire year, we will not use a cyclic spline. 

```{r}
source("pigfxns.R")
# Extract hour of day for spline fitting
txdat[ , datetime:=as.POSIXct(t, origin = '1970-01-01', tz = 'GMT')]
txdat[ , hourofday:=hour(datetime)]
txdat[ , monthofyear:=month(datetime)]

# Since these pigs were not sampled over a full year, do not use a cyclic spline for the month effects. 
Xgam_tx = build_gam_design_matrix(Xmat_tx, txdat, c("(Intercept)", "crw_z", "sexM"), df=6, cyclic_year=FALSE)
```

```{r}
require(doMC)
registerDoMC(cores=4)

# Regularize the fit
fittxcamp_gam = cv.glmnet(x=Xgam_tx, y=txdat$z, offset=log(txdat$tau), 
                    family="poisson", alpha=1, nlambda=20, nfolds=4, parallel=TRUE)
```

```{r}
plot(fittxcamp_gam)
tx_gambetas = fittxcamp_gam$glmnet.fit$beta[, which(fittxcamp_gam$lambda == fittxcamp_gam$lambda.1se), drop=T]
tx_gambetas
```

```{r}
library(ggplot2)
splinehour = s(hourofday, bs="cc", k=6)
pred_hours = Predict.matrix(smooth.construct2(splinehour, txdat, NULL), data.frame(hourofday=1:24)) # B-spline basis for hour effect

dailyres_tx = list()
for(pattern in c("hour_*")){
  
  eff = pred_hours %*% t(t(tx_gambetas[names(tx_gambetas) %like% pattern]))
  effdt = data.frame(hour=1:24, beta=eff, coef=pattern)
  dailyres_tx[[pattern]] = effdt
}

dailyres_tx = do.call(rbind, dailyres_tx)
ggplot(dailyres_tx) + geom_line(aes(x=hour, y=beta)) + xlab("Hour of day") + ylab("Daily Rate") + theme_bw() + facet_wrap(~coef)
```

```{r}
library(ggplot2)
splinemonth = s(monthofyear, bs="cr", k=5)
pred_months = Predict.matrix(smooth.construct2(splinemonth, txdat, NULL), data.frame(monthofyear=seq(1, 8, len=50))) # B-spline basis for month effect

monthlyres_tx = list()
for(pattern in c("cover_loc_*", "cover_grad_*", "crop_grad_*", "crop_loc_*", "water_loc_*", "water_grad_*",
                 "month_*", "masting_loc_*", "masting_grad_*", "ndvi_loc_*", "ndvi_grad_*")){
  
  eff = pred_months %*% t(t(tx_gambetas[names(tx_gambetas) %like% pattern]))
  effdt = data.frame(month=seq(1, 8, len=50), beta=eff, coef=pattern)
  monthlyres_tx[[pattern]] = effdt
}

monthlyres_tx = do.call(rbind, monthlyres_tx)
ggplot(monthlyres_tx) + geom_line(aes(x=month, y=beta)) + xlab("Month of year") + ylab("Monthly Rate") + theme_bw() + facet_wrap(~coef, scales="free")
```


Plot the effects simultaneously for both sites

```{r}

dailyres$study = "tejon"
dailyres_tx$study = "txcamp"
fulldaily = rbind(dailyres, dailyres_tx)
ggplot(fulldaily) + geom_line(aes(x=hour, y=beta, color=study)) + xlab("Hour of day") + ylab("Effect on movement rate") + theme_bw() + facet_wrap(~coef)
```

```{r}
monthlyres$study = "tejon"
monthlyres_tx$study = "txcamp"
fullmonthly = rbind(monthlyres, monthlyres_tx)
ggplot(fullmonthly) + geom_line(aes(x=month, y=beta, color=study)) + xlab("Month of year") + ylab("Effect on rate") + theme_bw() + facet_wrap(~coef, scales="free")

```

## Step 3: Interactive effects of resources on pig movement

This a more complicated model because now we are looking at how different foraging resources interact to affect pig movement.  In others words, given a pig is in or near a natural or agricultural resource, how does the presence of another resource (or distance to that resource) affect the time the pigs spends in the current resource.

For this analysis, we are going to keep the strong effects of hour and month on general movement patterns, but only consider interactions between static forage resources (i.e. the effects of resources are not time varying).  

For Tejon first:

```{r}
# Use the preexisting matricies to compute the new design matrix
source("pigfxns.R")
inttej = build_design_matrix(tejondat, c("crop"), modeltype = "interactions")
tejondat = inttej$data

Xint_tej = cbind(model.matrix(inttej$evalform, inttej$data), Xgam_tej[, c(paste0("hour_", 1:5), paste0("month_", 1:5))])
fwrite(as.data.table(Xint_tej), "../results/temp_Xgam_tej.csv")
```

```{r}
fittej_int = cv.glmnet(Xint_tej, y=tejondat$z, offset=log(tejondat$tau), 
                    family="poisson", alpha=1, nlambda=20, nfolds=4, parallel=TRUE)
```

```{r}
plot(fittej_int)
fittej_int$glmnet.fit$beta[, which(fittej_int$lambda == fittej_int$lambda.1se), drop=F]
```

I am not totally sure how to interpret this, but this is saying that if a pig is far from crops, they spend a decreasing about of time in patches with high NDVI compared to when they are closer to crops.  Weird.  Maybe this is driven by a single pig? 

---

Same analysis for Camp Bullis

```{r}
# Use the preexisting matricies to compute the new design matrix
source("pigfxns.R")
inttxcamp = build_design_matrix(txdat, c("crop"), modeltype = "interactions")

Xint_tx = cbind(model.matrix(inttxcamp$evalform, inttxcamp$data), Xgam_tx[, c(paste0("hour_", 1:5), paste0("month_", 1:5))])
```

```{r}
fittx_int = cv.glmnet(Xint_tx, y=txdat$z, offset=log(txdat$tau), 
                    family="poisson", alpha=1, nlambda=20, nfolds=4, parallel=TRUE)
```

```{r}
plot(fittx_int)
fittx_int$glmnet.fit$beta[, which(fittx_int$lambda == fittx_int$lambda.1se), drop=F]
```

Not really any "significant" interactions between agricultural forage resources and natural resources in the Camp Bullis population. 

## Step 4: Replacing time-varying parameters with temperature and precipitation interactions

This will be similar to model 2, but instead of basis functions that vary by month (we will keep the daily basis function), we will replace these effect by interactions with temperature and precipitation. 

```{r}
source("pigfxns.R")
temp_tej = build_design_matrix(tejondat, c("crop"), modeltype = "full")
tejondat = temp_tej$data

Xtemp_tej = cbind(model.matrix(temp_tej$evalform, temp_tej$data), Xgam_tej[, paste0("hour_", 1:5)])
```

```{r}
fittej_temp = cv.glmnet(Xtemp_tej, y=tejondat$z, offset=log(tejondat$tau), 
                    family="poisson", alpha=1, nlambda=20, nfolds=4, parallel=TRUE)
```

```{r}
plot(fittej_temp)
fittej_temp$glmnet.fit$beta[, which(fittej_temp$lambda == fittej_temp$lambda.1se), drop=F]
```

What do the temperature, precipitation, and NDVI cruves look like?

```{r}
meanvals = tejondat[, list(meantemp=mean(temperature_loc), meanprecip=mean(precipitation_loc), meanndvi=mean(ndvi_loc)), by=monthofyear]
ggplot(meanvals) + geom_line(aes(x=monthofyear, y=meanndvi)) + theme_bw()
ggplot(meanvals) + geom_line(aes(x=monthofyear, y=meantemp)) + theme_bw()
ggplot(meanvals) + geom_line(aes(x=monthofyear, y=meanprecip)) + theme_bw()

```

---

Similar analysis for Camp Bullis

```{r}
source("pigfxns.R")
temp_tx = build_design_matrix(txdat, c("crop"), modeltype = "full")
txdat = temp_tx$data

Xtemp_tx = cbind(model.matrix(temp_tx$evalform, temp_tx$data), Xgam_tx[, paste0("hour_", 1:5)])
```

```{r}
fittx_temp = cv.glmnet(Xtemp_tx, y=txdat$z, offset=log(txdat$tau), 
                    family="poisson", alpha=1, nlambda=20, nfolds=4, parallel=TRUE)
```

```{r}
plot(fittx_temp)
fittx_temp$glmnet.fit$beta[, which(fittx_temp$lambda == fittx_temp$lambda.1se), drop=F]
```

```{r}
meanvals = txdat[, list(meantemp=mean(temperature_loc), meanprecip=mean(precipitation_loc), meanndvi=mean(ndvi_loc)), by=monthofyear]
ggplot(meanvals) + geom_line(aes(x=monthofyear, y=meanndvi)) + theme_bw()
ggplot(meanvals) + geom_line(aes(x=monthofyear, y=meantemp)) + theme_bw()
ggplot(meanvals) + geom_line(aes(x=monthofyear, y=meanprecip)) + theme_bw()

```

Similar to the temporal analysis, there do not seem to be strong effects of temperature and precipitation on resource use in the Camp Bullis population. Would we expect less signature of resource availability on movement when resources are fairly ubiquitously distributed over a landscape?  I would expect so.  

Let's look at the coefficient of variation in the three forage resources in both Camp Bullis and Tejon

```{r}
tejoncv = tejondat[, list(cvcrop= sd(crop_loc) / mean(crop_loc), cvndvi=sd(ndvi_loc) / mean(ndvi_loc), cvmasting=sd(masting_loc) / mean(masting_loc))]
txcampcv = txdat[, list(cvcrop= sd(crop_loc) / mean(crop_loc), cvndvi=sd(ndvi_loc) / mean(ndvi_loc), cvmasting=sd(masting_loc) / mean(masting_loc))]


rbind(tejoncv, txcampcv)
```

There is less spatial variability in "natural" forage resources in Camp Bullis than in Tejon, which could diminish the effect on movement. Could be an interesting population-level predictor to consider for why the the role of natural vs crop resources on pig movement varies between population. The hypothesis is that with more homogeneous resource distributions (at what scale?), there is less signature of resource selection as pigs can wander more freely without worrying about getting to or staying in a particular resource patch. In general, the effects of all resources seem to be less in Camp Bullis, and I would suspect that has to do with the generally availability of resource (water and forage), though it would be nice to confirm this.  If each chosen cell is "as good as" the next, then resource selection should have little effect on pig movement and movement should be dominated by a random walk or other biological factors (escape from predation?). 