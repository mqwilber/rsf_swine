---
title: "Data summary for pig RSF project"
author: "Mark Wilber and Sarah Chinn"
output:
  html_notebook: default
  pdf_document: default
---

## Data overview

```{r, echo=FALSE, message=FALSE}
library(data.table)
library(ggplot2)
dat = fread("~/Repos/rsf_swine/data/formatted/full_pig_data.csv")
```

The total data that is available for the pig study consists of

- 24 studies
- 500 pigs
- 1714595 fixes across all studies

Geographically, this is the extent of our data

```{r, message=FALSE, echo=FALSE}
library(ggmap)

drop = 20 # Drop the first 20 points of any pig.
meandat = dat[order(pigID, datetime), ][,list(meanlat = mean(latitude[drop:length(latitude)]), meanlong = mean(longitude[drop:length(latitude)])), by=list(study, pigID)][]

us <- c(left = -125, bottom = 23.75, right = -67, top = 54)
map <- get_stamenmap(us, zoom = 5, maptype = "toner-lite")
plt = ggmap(map) + geom_point(data=meandat, aes(x=meanlong, y=meanlat, color=study), size=1)
plt
```

The study IDs are unique identifiers for different studies which are described in the file `data_descriptions.docx`.  

## Summary statistics of data

Some basic summary statistics for each study.  Includes the number of pigs (`numpigs`), the minimum lat/long, the maximum lat/long, and the number of fixes (`numfixes`) in each study.

```{r, echo=FALSE}

dat[ , list(numpigs=length(unique(pigID)), minlat=min(latitude),
            maxlat=max(latitude), minlong=min(longitude), maxlong=max(longitude),
            numfixes=length(pigID)),
            by=study]
```

## Pig attributes by site

### Pig sex data

How does pig sex varies across studies?

```{r, echo=FALSE}
attrib = fread("~/Repos/rsf_swine/data/formatted/pig_attributes.csv")

attrib[ , list(numfem=sum(sex == "F"), nummale=sum(sex == "M"), 
               unknown=sum(sex == "")), by=study]
```

Of the 500 pigs, there are 15 for which we still do not have sex data.

### Pig weight data

```{r, echo=FALSE}
wdat = attrib[, list(number_with_weight = sum(!is.na(weight_lb))), by=list(study)]
wdat
```

Generally, we currently don't have weight data for the studies from the movement study (Kay et al. 2017 *Movement Ecology*) or the Canada pigs.  We likely won't use weight as a variable for the large scale analysis, so this is probably ok.  Though do plan to focus on weight for more site specific anlayses.

```{r, echo=FALSE}
totweight = sum(wdat$number_with_weight)
```

## Summary of collaring and fix times

```{r, echo=FALSE}
dat$datetime = as.POSIXct(dat$datetime, tz="GMT")
```

Look at the distribution of collaring times per pig for the different studies.  Note that `study == "canada"` has not been cleaned, it has some large collaring times. There are a number of other points that also indicate that additional data cleaning will be necessary before fitting the resource/movement models.

```{r, echo=FALSE}
drop = 0
collarDur = dat[, list(deltat=max(datetime[drop:length(datetime)]) - min(datetime[drop:length(datetime)]), 
                       maxdate=max(datetime[drop:length(datetime)]), 
                       mindate=min(datetime[drop:length(datetime)])), 
                    by=list(study, pigID)]

ggplot(data=collarDur) + geom_boxplot(aes(x=study, y=deltat)) + theme_bw() + 
                xlab("Study") + ylab("Length of collaring time per pig per study in days") + 
                theme(axis.text.x = element_text(angle = 90, hjust = 1))
                
```

What are the median fix times per study?

```{r, echo=FALSE}
fixtimes = dat[order(pigID, datetime), list(fixtime = median(diff(datetime))), by=list(study)]
units(fixtimes$fixtime) = "mins"
ggplot(fixtimes) + geom_boxplot(aes(x=study, y=fixtime)) + theme_bw() + 
                xlab("Study") + ylab("Median fix time in minutes") + 
                theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

Most studies have a median fix time of 1 hour or less,  with the exception of `ga_bill` and `sc_jim1`.

---

The following pigs have runs of at least 500 consecutive fixes that are less or equal to 120 minutes apart.

```{r, echo=FALSE}
source("pigfxns.R")

fixrun = dat[order(pigID, datetime), list(hasrun=runs(datetime, ctime=120, clength=500)), by=list(study, pigID)][, list(totpigs=sum(hasrun)), by=study][totpigs != 0]
fixrun

```

12 studies and 159 pigs have at least 500 consecutive fixes that are less than or equal to 120 minutes apart.  This is a pretty stingy criteria, so let's looks at 200 consecutive fixes that are less than ~3 hrs apart.

```{r, echo=FALSE}
fix2 = dat[order(pigID, datetime), list(hasrun=runs(datetime, ctime=190, clength=200)), by=list(study, pigID)][, list(totpigs=sum(hasrun)), by=study][totpigs != 0]
fix2
```

This gives us 4 more studies and 305 pigs. Basically, what this summary is showing is that we might not be using all 500 pigs when looking at resource selection.

## Temporal distribution of collaring times

Visualize the overlap between the extent of collaring times and individual pigs. 

```{r, echo=FALSE}
tplot = ggplot(data=collarDur) + geom_linerange(aes(x=pigID, ymin=mindate, ymax=maxdate)) + 
          facet_wrap(~study, scales = 'free') + 
          theme(axis.text.x = element_text(angle = 90, hjust = 1,  size=0))
tplot
#ggsave("temp.pdf", height=15, width=15)
```
