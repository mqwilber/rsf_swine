---
title: "Exploratory data analysis for pig data"
output: html_notebook
---

# Basic data cleaning

```{r}
# Load in the pig data
library(data.table)
dt = fread("../data/formatted/full_pig_data.csv")
```

Check for and remove missing lat-long values

```{r}
ind = is.na(dt$latitude) | is.na(dt$longitude)
sum(ind)
dt_trun = dt[!ind, ]
dim(dt_trun)
```
Pigs between studies can have the same collar number so let's make unique pig collars.

```{r}
# Make a unique pigID
dt_trun[, pigID:=paste(collarID, study, sep="")]
```

Dates are not in the same format. Strip all white spcae out of the dates

```{r}
lmt_date = tstrsplit(dt_trun$lmt_date, " ")[[1]]
dt_trun$lmt_date_strp = lmt_date
```

Combine date and time into one vector

```{r}
datetime = as.character(paste(dt_trun$lmt_date_strp, dt_trun$lmt_time))

# studies michigan and srel_jim don't have ant seconds on the datetimes..add 00
for(study in c("michigan", "srel_jim")){
  datetime[dt_trun$study == study] = paste(datetime[dt_trun$study == study], ":00", sep="")
}

dt_trun$datetime = as.POSIXct(strptime(datetime, format="%m/%d/%y %H:%M:%S", tz="GMT"))
```

## Some exploratory data analysis

Get the maximum time length at which fixings were taken for each individual pig

```{r}
fixinfo = dt_trun[, list(study=unique(study),
                         deltat = max(datetime) - min(datetime), 
                         numfixes=length(datetime),
                         start=min(datetime),
                         end=max(datetime)), by=list(pigID)]
fixinfo
```

Any pigs nan?

```{r}
nanpigs = fixinfo[is.na(fixinfo$deltat), "pigID"]
nanpigs
```

All pigs have the correct datetime specifications.




Order by fix times.  

```{r}
fixinfo[order(deltat, decreasing = T)]
```

Large variation in how long pigs were collared for. 

```{r}
fixinfo[, fixrate:= numfixes / as.numeric(deltat)]
fixinfo[, timeperfix:= (as.numeric(deltat) / numfixes)*24*60]
fixinfo[order(timeperfix, decreasing = F), ]
```

---

Let's look at a distribution of collaring times

```{r}
library(ggplot2)
ggplot(fixinfo, aes(x=as.numeric(log10(as.numeric(deltat))))) + geom_histogram() + xlab("log10(days)")
```

Something seems a little wierd with the huge fix time!   Will have to check if this pig is an outlier or perhaps the collar just gave a reading when it wasn't on the pig.

```{r}
fixinfo[which.max(fixinfo$deltat), ]
```
  
Let's look at deltat by study

```{r}
ggplot(fixinfo, aes(x=as.numeric(deltat))) + geom_histogram() + facet_wrap(~study)
```


For each pig by study, let's look at how long they were tagged for

```{r}
studies = unique(fixinfo$study)

plots = list()
for(i in 1:length(studies)){
  
  plots[[i]] = ggplot(data=fixinfo[study==studies[i]], aes(pigID)) + geom_linerange(aes(ymin=start, ymax=end)) + 
    facet_wrap(~study, scales = "free") + theme(axis.text.x = element_text(angle = 90, hjust = 1, size=8))
}
```

```{r}
for(i in 1:length(plots)){
  print(plots[[i]])
}
```

There is some overlap in the times that pig were tagged within sutdies.  Not yet sure between studies though. Ideally, if our question is how pig movement changes across studies

Some summary stats by study

```{r}
# Order the GPS colors by pig and time 
dt_trun = dt_trun[order(pigID, datetime)]
diffs = dt_trun[, list(deltat=mean(diff(datetime))), by=list(pigID)]

ggplot(diffs, aes(x=deltat / (60 * 24))) + geom_histogram() + xlab("Days")
```

Some pigs have a huge about of time between their GPS readings...

---

## Determing which sequences will be useful for movement analysis

Which pigs have a sequences of at least 10 where each fix is less than 1hr different
from the previous fix?

```{r}
runs = function(x, ctime=60, clength=10){
  # Given a vector of time differneces X
  # determine if the vector has a run of 
  # clength or greater of diffs < ctime (in minutes). 
  # Parameters
  # ----------
  # x : difference vector of times
  # ctime : Diffs must be less than this time
  # clength : Length of a run
  
  # Notes
  # -----
  # This will help identify potential trajectories to use for the movement study
  # Returns TRUE or FALSE
  
  deltat = diff(x)
  inds = deltat < ctime # String of booleans
  
  # Count runs
  run_vect = rle(inds)
  res = any((run_vect$values == TRUE) & (run_vect$lengths >= clength))
  return(res)
  
}

long_pigs = dt_trun[, list(longdat=runs(datetime), study=unique(study)), by=pigID]
print(sum(long_pigs$longdat))
print(nrow(long_pigs))
table(long_pigs$study[long_pigs$longdat])
```

212 pigs have at least 10 fixes in a row that are within 1 hr of each other. 

Let's just focus on these pigs for now. 

```{r}
# Subset data to only include pigs that have the right length of data
keys = long_pigs$pigID[long_pigs$longdat]

# Should be a cleaner and faster way to do this...perhaps with match
inds = rep(FALSE, nrow(dt_trun))
for(key in keys){
  inds = inds | (dt_trun$pigID == key)
}

# Remove the pigs that 
movedt = dt_trun[inds]
```


```{r}
table(movedt$study)
```


## Plot pig movement trajectories for each study

```{r}
library(ggmap)

# All the pig data
us <- c(left = -125, bottom = 25.75, right = -67, top = 49)
map <- get_stamenmap(us, zoom = 5, maptype = "toner-lite")
ggmap(map) + geom_point(data=dt_trun, aes(x=longitude, y=latitude, color=study))
```

```{r}
# Pig data that will probably be useful for movement models
us <- c(left = -125, bottom = 25.75, right = -67, top = 49)
map <- get_stamenmap(us, zoom = 5, maptype = "toner-lite")
ggmap(map) + geom_point(data=movedt, aes(x=longitude, y=latitude))
```


Look at a plot of pig movement in Texas.

```{r}
library(dplyr)
txcamp = movedt[pigID == "20125txcamp"]
map = get_googlemap(center=c(lon=-98.53675, lat=29.74411), zoom=14, maptype="hybrid") %>% ggmap()
map = map + geom_path(data=txcamp, aes(x=longitude, y=latitude), size=0.5)
map
```

```{r}
# Single pig diff
pigdiff = diff(txcamp$datetime)

inds = pigdiff < 100 # String of booleans
  
  # Count runs
run_vect = rle(inds)
run_vect
```

```{r}
write.csv(movedt, "../data/formatted/pig_trajectories.csv")
```
